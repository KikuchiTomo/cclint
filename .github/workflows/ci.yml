name: CI

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-ubuntu:
    name: Build on Ubuntu
    runs-on: ubuntu-22.04

    strategy:
      matrix:
        compiler: [g++-11, g++-12, clang++-14, clang++-15]
        build_type: [Release, Debug]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake

    - name: Install compiler
      run: |
        if [[ "${{ matrix.compiler }}" == g++* ]]; then
          sudo apt-get install -y ${{ matrix.compiler }}
        else
          sudo apt-get install -y ${{ matrix.compiler }}
        fi

    - name: Configure CMake
      run: |
        export CXX=${{ matrix.compiler }}
        mkdir build
        cd build
        cmake -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} ..

    - name: Build
      run: |
        cd build
        make -j$(nproc)

    - name: Check binary
      run: |
        ./build/src/cclint --version
        ./build/src/cclint --help

    - name: Test basic functionality
      run: |
        echo '#include <iostream>' > test.cpp
        echo 'int main() { return 0; }' >> test.cpp
        ./build/src/cclint -v ${{ matrix.compiler }} -std=c++17 test.cpp

    - name: Upload binary artifact
      if: matrix.build_type == 'Release' && matrix.compiler == 'g++-11'
      uses: actions/upload-artifact@v4
      with:
        name: cclint-ubuntu-${{ matrix.compiler }}
        path: build/src/cclint

  build-macos:
    name: Build on macOS
    runs-on: macos-latest

    strategy:
      matrix:
        build_type: [Release, Debug]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        brew install cmake

    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} ..

    - name: Build
      run: |
        cd build
        make -j$(sysctl -n hw.ncpu)

    - name: Check binary
      run: |
        ./build/src/cclint --version
        ./build/src/cclint --help

    - name: Test basic functionality
      run: |
        echo '#include <iostream>' > test.cpp
        echo 'int main() { return 0; }' >> test.cpp
        ./build/src/cclint -v clang++ -std=c++17 test.cpp

    - name: Upload binary artifact
      if: matrix.build_type == 'Release'
      uses: actions/upload-artifact@v4
      with:
        name: cclint-macos
        path: build/src/cclint

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format-14

    - name: Check code formatting
      run: |
        find src -name '*.cpp' -o -name '*.hpp' | xargs clang-format-14 --dry-run --Werror

    - name: Install clang-tidy
      run: |
        sudo apt-get install -y clang-tidy-14

    - name: Run clang-tidy
      run: |
        mkdir build
        cd build
        cmake ..
        cd ..
        # Run clang-tidy on main source files
        clang-tidy-14 src/main.cpp src/cli/*.cpp src/config/*.cpp -- -std=c++17 || true

  lua-scripts-check:
    name: Validate Lua Scripts
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Lua
      run: |
        sudo apt-get update
        sudo apt-get install -y lua5.3

    - name: Check Lua syntax
      run: |
        find scripts/rules -name '*.lua' -exec luac -p {} \;

    - name: Count Lua scripts
      run: |
        SCRIPT_COUNT=$(find scripts/rules -name '*.lua' | wc -l)
        echo "Found $SCRIPT_COUNT Lua rule scripts"
        if [ $SCRIPT_COUNT -ne 102 ]; then
          echo "Expected 102 Lua scripts, found $SCRIPT_COUNT"
          exit 1
        fi

  documentation-check:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Check required documentation files
      run: |
        REQUIRED_DOCS="README.md WORK_SUMMARY.md docs/requirements.md docs/design.md docs/detailed_design.md docs/milestones.md docs/TODO.md docs/build.md docs/usage.md docs/troubleshooting.md"
        for doc in $REQUIRED_DOCS; do
          if [ ! -f "$doc" ]; then
            echo "Missing required documentation: $doc"
            exit 1
          fi
        done

    - name: Check for broken links in README
      run: |
        # Simple check for .md files referenced in README
        if grep -E '\[.*\]\(.*\.md\)' README.md; then
          echo "Found markdown links in README"
        fi

  build-script-test:
    name: Test Build Script
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake g++

    - name: Test build script help
      run: |
        ./build.sh --help

    - name: Test clean build
      run: |
        ./build.sh --clean

    - name: Verify binary
      run: |
        test -f build/src/cclint
        ./build/src/cclint --version

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [build-ubuntu, build-macos, code-quality, lua-scripts-check, documentation-check, build-script-test]
    if: always()

    steps:
    - name: Check results
      run: |
        echo "CI Pipeline Summary:"
        echo "- Build Ubuntu: ${{ needs.build-ubuntu.result }}"
        echo "- Build macOS: ${{ needs.build-macos.result }}"
        echo "- Code Quality: ${{ needs.code-quality.result }}"
        echo "- Lua Scripts: ${{ needs.lua-scripts-check.result }}"
        echo "- Documentation: ${{ needs.documentation-check.result }}"
        echo "- Build Script: ${{ needs.build-script-test.result }}"

    - name: Fail if any job failed
      if: |
        needs.build-ubuntu.result == 'failure' ||
        needs.build-macos.result == 'failure' ||
        needs.code-quality.result == 'failure' ||
        needs.lua-scripts-check.result == 'failure' ||
        needs.documentation-check.result == 'failure' ||
        needs.build-script-test.result == 'failure'
      run: exit 1
